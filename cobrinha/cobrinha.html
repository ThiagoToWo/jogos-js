<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Cobrinha</title>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            background-color: #000;
        }

        #botoes {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30%;
        }

        #verticais button {
            display: block;
        }

        button {
            font-weight: bold;
            width: 80px;
            height: 80px;
        }
    </style>

    <script id="engine">
        // Engine
        let canvas;
        let context;
        let log; // marca os pontos e mostra informações do jogo

        let cobrinha;
        let maca;
        const pressionadas = [];

        const CARREGANDO = 0;
        const JOGANDO = 1;
        const MORREU = 2;

        let estadoAtual = CARREGANDO;

        const W = 10;

        window.addEventListener("keydown", (e) => {
            console.log(e.key)
            switch (e.key) {
                case "ArrowLeft":
                    pressionadas[0] = true;
                    pressionadas[1] = false;
                    pressionadas[2] = false;
                    pressionadas[3] = false;
                    break;
                case "ArrowUp":
                    pressionadas[0] = false;
                    pressionadas[1] = true;
                    pressionadas[2] = false;
                    pressionadas[3] = false;
                    break;
                case "ArrowRight":
                    pressionadas[0] = false;
                    pressionadas[1] = false;
                    pressionadas[2] = true;
                    pressionadas[3] = false;
                    break;
                case "ArrowDown":
                    pressionadas[0] = false;
                    pressionadas[1] = false;
                    pressionadas[2] = false;
                    pressionadas[3] = true;
                    break;
            }
        });

        function iniciarJogo() {
            switch (estadoAtual) {
                case CARREGANDO:
                    carregarJogo();
                    estadoAtual = JOGANDO;
                    break;
                case JOGANDO:
                    processarJogo();
                    break;
                case MORREU:
                    processarMorte();
                    pausarPor(1500);
                    estadoAtual = CARREGANDO;
                    break;
            }

            renderizar();
        }

        function carregarJogo() {
            const numCelulasX = canvas.width / W;
            const numCelulasY = canvas.height / W;

            const xc = W * numCelulasX / 2;
            const yc = W * numCelulasY / 2;
            cobrinha = new Cobrinha(xc, yc, W, W, context);

            const xm = W + W * Math.floor(Math.random() * (numCelulasX - 2));
            const ym = W + W * Math.floor(Math.random() * (numCelulasY - 2));
            maca = new Maca(xm, ym, W, W, context);

            log.innerText = cobrinha.corpo.length;
            console.log("Jogo Carregado", "maçã.x:", maca.x, "maçã.y:", maca.y);
        }

        function processarJogo() {
            cobrinha.atualizar()

            if (cobrinha.colidiuCom(maca)) {
                console.log("Colidiu com Maçã");

                cobrinha.corpo.push(
                    {
                        x: -W,
                        y: -W,
                        w: W,
                        h: W
                    }
                );

                const numCelulasX = canvas.width / W;
                const numCelulasY = canvas.height / W;
                const xm = W + W * Math.floor(Math.random() * (numCelulasX - 2));
                const ym = W + W * Math.floor(Math.random() * (numCelulasY - 2));
                maca = new Maca(xm, ym, W, W, context);

                log.innerText = cobrinha.corpo.length;
            }

            for (let i = 2; i < cobrinha.corpo.length; i++) {
                if (cobrinha.colidiuCom(cobrinha.corpo[i])) {
                    console.log("Colidiu com a parte", i)
                    estadoAtual = MORREU;
                }
            }

            if (cobrinha.corpo[0].x < 0) {
                cobrinha.corpo[0].x = canvas.width - W;
            }

            if (cobrinha.corpo[0].y < 0) {
                cobrinha.corpo[0].y = canvas.height - W;
            }

            if (cobrinha.corpo[0].x + cobrinha.corpo[0].w > canvas.width) {
                cobrinha.corpo[0].x = 0;
            }

            if (cobrinha.corpo[0].y + cobrinha.corpo[0].h > canvas.height) {
                cobrinha.corpo[0].y = 0;
            }
        }

        function processarMorte() {
            console.log("Morreu");

            pressionadas[0] = false;
            pressionadas[1] = false;
            pressionadas[2] = false;
            pressionadas[3] = false;
        }

        function renderizar() {
            context.clearRect(0, 0, canvas.width, canvas.height);

            cobrinha.desenhar();

            maca.desenhar();
        }

        function pausarPor(ms) {
            const t0 = new Date().getTime();
            let t = new Date().getTime();

            while (t - t0 < ms) {
                t = new Date().getTime();
            }
        }
    </script>

    <script id="classes">
        class Cobrinha {
            constructor(x, y, w, h, context) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.v = this.w;
                this.corpo = [
                    {
                        x: this.x,
                        y: this.y,
                        w: this.w,
                        h: this.h
                    }
                ],
                this.ctx = context;
            }

            atualizar() {
                if (pressionadas[0]) {
                    this.corpo.unshift(
                        {
                            x: this.corpo[0].x - this.v,
                            y: this.corpo[0].y,
                            w: this.w,
                            h: this.h
                        }
                    );

                    this.corpo.pop();
                }

                if (pressionadas[1]) {
                    this.corpo.unshift(
                        {
                            x: this.corpo[0].x,
                            y: this.corpo[0].y - this.v,
                            w: this.w,
                            h: this.h
                        }
                    );

                    this.corpo.pop();
                }

                if (pressionadas[2]) {
                    this.corpo.unshift(
                        {
                            x: this.corpo[0].x + this.v,
                            y: this.corpo[0].y,
                            w: this.w,
                            h: this.h
                        }
                    );

                    this.corpo.pop();
                }

                if (pressionadas[3]) {
                    this.corpo.unshift(
                        {
                            x: this.corpo[0].x,
                            y: this.corpo[0].y + this.v,
                            w: this.w,
                            h: this.h
                        }
                    );

                    this.corpo.pop();
                }
            }

            desenhar() {
                this.ctx.save();

                this.ctx.fillStyle = "#fff";
                for (let i = this.corpo.length - 1; i > 0; i--) {
                    this.ctx.fillRect(this.corpo[i].x, this.corpo[i].y, this.corpo[i].w, this.corpo[i].h);
                }

                this.ctx.fillStyle = "#666";
                this.ctx.fillRect(this.corpo[0].x, this.corpo[0].y, this.corpo[0].w, this.corpo[0].h);

                this.ctx.restore();
            }

            colidiuCom(elemento) {
                return this.corpo[0].x == elemento.x &&
                    this.corpo[0].y == elemento.y;
            }
        }

        class Maca {
            constructor(x, y, w, h, context) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.ctx = context;
            }

            desenhar() {
                this.ctx.save();
                this.ctx.fillStyle = "#f00";
                this.ctx.fillRect(this.x, this.y, this.w, this.h);
                this.ctx.restore();
            }
        }
    </script>
</head>

<body>
    <div id="container">
        <h1>Jogo da Cobrinha</h1>
        <canvas id="canvas" width="360" height="400"></canvas>
        <h3>Tamanho: <span id="spnTamanho"></span></h3>
        <div id="botoes">
            <div id="horizontais">
                <button id="btEsquerda">Esquerda</button>
                <button id="btDireita">Direita</button>
            </div>
            <div id="verticais">
                <button id="btCima">Cima</button>
                <button id="btBaixo">Baixo</button>
            </div>            
        </div>
    </div>

    <script>
        const btEsquerda = document.querySelector("#btEsquerda");
        const btDireita = document.querySelector("#btDireita");
        const btCima = document.querySelector("#btCima");
        const btBaixo = document.querySelector("#btBaixo");
        log = document.querySelector("#spnTamanho");

        btEsquerda.addEventListener("click", (e) => {
            e.preventDefault();

            pressionadas[0] = true;
            pressionadas[1] = false;
            pressionadas[2] = false;
            pressionadas[3] = false;

        });

        btCima.addEventListener("click", (e) => {
            e.preventDefault();

            pressionadas[0] = false;
            pressionadas[1] = true;
            pressionadas[2] = false;
            pressionadas[3] = false;

        });

        btDireita.addEventListener("click", (e) => {
            e.preventDefault();

            pressionadas[0] = false;
            pressionadas[1] = false;
            pressionadas[2] = true;
            pressionadas[3] = false;

        });

        btBaixo.addEventListener("click", (e) => {
            e.preventDefault();

            pressionadas[0] = false;
            pressionadas[1] = false;
            pressionadas[2] = false;
            pressionadas[3] = true;

        });

        canvas = document.querySelector("#canvas");
        context = canvas.getContext("2d");

        setInterval(iniciarJogo, 200);
    </script>
</body>

</html>